/*! skywayjs - v0.1.0 - 2014-08-08 */
(function(){function Skyway(){return this instanceof Skyway?(this.VERSION="0.1.0",this.ICE_CONNECTION_STATE={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},this.PEER_CONNECTION_STATE={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",ESTABLISHED:"established",CLOSED:"closed"},this.CANDIDATE_GENERATION_STATE={GATHERING:"gathering",DONE:"done"},this.HANDSHAKE_PROGRESS={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer"},this.DATA_CHANNEL_STATE={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",NEW:"new",LOADED:"loaded",ERROR:"error"},this.SYSTEM_ACTION={WARNING:"warning",REJECT:"reject",CLOSED:"close"},this.READY_STATE_CHANGE={INIT:0,LOADING:1,COMPLETED:2,ERROR:0,APIERROR:-2},this.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},this.DATA_TRANSFER_DATA_TYPE={BINARYSTRING:"binaryString",ARRAYBUFFER:"arrayBuffer",BLOB:"blob"},this._path=null,this._key=null,this._socket=null,this._socketVersion=null,this._user=null,this._room=null,this._peerConnections=[],this._browser=null,this._readyState=0,this._channel_open=!1,this._in_room=!1,this._uploadDataTransfers={},this._downloadDataTransfers={},this._dataTransfersTimeout={},this._chunkFileSize=49152,this._requireVideo=!0,this._chatSig=!0,this._chatDC=!0,this._loadSocket=function(ipSigserver,portSigserver,onSuccess,onError){var socketScript=document.createElement("script");socketScript.src="http://"+ipSigserver+":"+portSigserver+"/socket.io/socket.io.js",socketScript.onreadystatechange=onSuccess,socketScript.onload=onSuccess,socketScript.onerror=onError,document.head.appendChild(socketScript)},this._parseInfo=function(info,self){return info.pc_constraints||info.offer_constraints?(self._key=info.cid,self._user={id:info.username,token:info.userCred,timeStamp:info.timeStamp,displayName:info.displayName,apiOwner:info.apiOwner,streams:[]},self._room={id:info.room_key,token:info.roomCred,start:info.start,len:info.len,signalingServer:{ip:info.ipSigserver,port:info.portSigserver},pcHelper:{pcConstraints:JSON.parse(info.pc_constraints),pcConfig:null,offerConstraints:JSON.parse(info.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}},void self._loadSocket(info.ipSigserver,info.portSigserver,function(){window.io&&(self._readyState=2,self._trigger("readyStateChange",self.READY_STATE_CHANGE.COMPLETED))},function(err){})):void self._trigger("readyStateChange",this.READY_STATE_CHANGE.APIERROR)},void(this._init=function(self){if(window.XMLHttpRequest&&window.RTCPeerConnection&&this._path){self._readyState=1,self._trigger("readyStateChange",self.READY_STATE_CHANGE.LOADING);var xhr=new window.XMLHttpRequest;xhr.onreadystatechange=function(){if(this.readyState===this.DONE){if(200!==this.status)return self._readyState=0,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR);self._parseInfo(JSON.parse(this.response),self),self._requireVideo&&self.getDefaultStream()}},xhr.open("GET",self._path,!0),xhr.send()}})):new Skyway}this.Skyway=Skyway,Skyway.prototype.on=function(eventName,callback){"function"==typeof callback&&(this._events[eventName]=this._events[eventName]||[],this._events[eventName].push(callback))},Skyway.prototype.off=function(eventName,callback){if(void 0===callback)return void(this._events[eventName]=[]);for(var arr=this._events[eventName],l=arr.length,i=0;l>i;i++)if(arr[i]===callback){arr.splice(i,1);break}},Skyway.prototype._trigger=function(eventName){var args=Array.prototype.slice.call(arguments),arr=this._events[eventName];args.shift();for(var e in arr)if(arr[e].apply(this,args)===!1)break},Skyway.prototype.init=function(roomserver,appID,room,requireVideo,startTime,duration,credential){roomserver.lastIndexOf("/")!==roomserver.length-1&&(roomserver+="/"),this._readyState=0,this._trigger("readyStateChange",this.READY_STATE_CHANGE.INIT),this._key=appID,this._requireVideo=requireVideo?requireVideo:!1,this._path=startTime&&duration&&credential?roomserver+"api/"+appID+"/"+room+"/"+startTime+"/"+duration+"?&cred="+credential:roomserver+"api/"+appID+"/"+room,this._init(this)},Skyway.prototype.setUser=function(user){this._user=user},Skyway.prototype._events={channelOpen:[],channelClose:[],channelMessage:[],channelError:[],joinedRoom:[],readyStateChange:[],handshakeProgress:[],candidateGenerationState:[],peerConnectionState:[],iceConnectionState:[],mediaAccessError:[],mediaAccessSuccess:[],chatMessage:[],peerJoined:[],peerLeft:[],presenceChanged:[],roomLock:[],addPeerStream:[],removePeerStream:[],peerVideoMute:[],peerAudioMute:[],addContact:[],removeContact:[],invitePeer:[],dataChannelState:[],startDataTransfer:[],dataTransfer:[],dataTransferCompleted:[],systemAction:[],privateMessage:[],publicMessage:[]},Skyway.prototype.sendChatMsg=function(chatMsg,targetPeerID){var msg_json={cid:this._key,data:chatMsg,mid:this._user.sid,nick:this._user.displayName,rid:this._room.id,type:"chat"};targetPeerID&&(msg_json.target=targetPeerID),this._sendMessage(msg_json),this._trigger("chatMessage",chatMsg,this._user.displayName,!!targetPeerID)},Skyway.prototype.sendPrivateMsg=function(data,targetPeerID){var msg_json={cid:this._key,data:data,mid:this._user.sid,nick:this._user.displayName,rid:this._room.id,type:"private"};targetPeerID&&(msg_json.target=targetPeerID),this._sendMessage(msg_json),this._trigger("privateMessage",data,this._user.displayName,targetPeerID,!0)},Skyway.prototype.sendPublicMsg=function(data){var msg_json={cid:this._key,data:data,mid:this._user.sid,nick:this._user.displayName,rid:this._room.id,type:"public"};this._sendMessage(msg_json),this._trigger("publicMessage",this._user.displayName,data,!0)},Skyway.prototype.getDefaultStream=function(){var self=this;try{window.getUserMedia({audio:!0,video:!0},function(s){self._onUserMediaSuccess(s,self)},function(e){self._onUserMediaError(e,self)})}catch(e){this._onUserMediaError(e,self)}},Skyway.prototype._onUserMediaSuccess=function(stream,self){self._trigger("mediaAccessSuccess",stream),self._user.streams.push(stream)},Skyway.prototype._onUserMediaError=function(e,self){e.message,e.constraintName,self._trigger("mediaAccessError",e.name||e)},Skyway.prototype._processSigMsg=function(message){var msg=JSON.parse(message);if("group"===msg.type)for(var i=0;i<msg.lists.length;i++)this._processSingleMsg(msg.lists[i]);else this._processSingleMsg(msg)},Skyway.prototype._processSingleMsg=function(msg){this._trigger("channelMessage");var origin=msg.mid;if(origin&&origin!==this._user.sid||(origin="Server"),msg.mid!==this._user.sid||"redirect"===msg.type||"inRoom"===msg.type||"chat"===msg.type)switch(msg.type){case"public":this._privateMsgHandler(msg);break;case"private":this._privateMsgHandler(msg);break;case"inRoom":this._inRoomHandler(msg);break;case"enter":this._enterHandler(msg);break;case"welcome":this._welcomeHandler(msg);break;case"offer":this._offerHandler(msg);break;case"answer":this._answerHandler(msg);break;case"candidate":this._candidateHandler(msg);break;case"bye":this._byeHandler(msg);break;case"chat":this._chatHandler(msg);break;case"redirect":this._redirectHandler(msg);break;case"update_guest_name":break;case"error":break;case"invite":break;case"video_mute_event":break;case"roomLockEvent":}},Skyway.prototype._chatHandler=function(msg){this._trigger("chatMessage",msg.data,msg.id===this._user.sid?"Me, myself and I":msg.nick,msg.target?!0:!1)},Skyway.prototype._redirectHandler=function(msg){this._trigger("systemAction",msg.action,msg.info)},Skyway.prototype._byeHandler=function(msg){var targetMid=msg.mid;this._removePeer(targetMid)},Skyway.prototype._privateMsgHandler=function(msg){this._trigger("privateMessage",msg.data,msg.nick,msg.target,!1)},Skyway.prototype._publicMsgHandler=function(msg){this._trigger("publicMessage",msg.nick,msg.data,!1)},Skyway.prototype._removePeer=function(peerID){this._trigger("peerLeft",peerID),this._peerConnections[peerID]&&this._peerConnections[peerID].close(),delete this._peerConnections[peerID]},Skyway.prototype._inRoomHandler=function(msg){var temp_config=msg.pc_config;if(window.webrtcDetectedBrowser.mozWebRTC){for(var newIceServers=[{url:"stun:stun.services.mozilla.com"}],i=0;i<msg.pc_config.iceServers.length;i++){var iceServer=msg.pc_config.iceServers[i],iceServerType=iceServer.url.split(":")[0];if("stun"===iceServerType){if(iceServer.url.indexOf("google"))continue;iceServer.url=[iceServer.url],newIceServers.push(iceServer)}else{var newIceServer={};newIceServer.credential=iceServer.credential,newIceServer.url=iceServer.url.split(":")[0],newIceServer.username=iceServer.url.split(":")[1].split("@")[0],newIceServer.url+=":"+iceServer.url.split(":")[1].split("@")[1],newIceServers.push(newIceServer)}}temp_config.iceServers=newIceServers}this._room.pcHelper.pcConfig=temp_config,this._in_room=!0,this._user.sid=msg.sid,this._trigger("joinedRoom",this._room.id,this._user.sid);var self=this,checkForStream=setInterval(function(){var waitForStream=self._requireVideo&&!(self._user&&self._user.streams.length>0);waitForStream||(clearInterval(checkForStream),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER),self._sendMessage({type:"enter",mid:self._user.sid,rid:self._room.id,nick:self._user.displayName}))},2e3)},Skyway.prototype._enterHandler=function(msg){var targetMid=msg.mid;if(!this._requireVideo||this._user.streams.length>0){if(this._trigger("handshakeProgress","enter",targetMid),this._trigger("peerJoined",targetMid),this._peerConnections[targetMid])return;this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.WELCOME,targetMid),this._sendMessage({type:"welcome",mid:this._user.sid,target:targetMid,rid:this._room.id,nick:this._user.displayName})}},Skyway.prototype._welcomeHandler=function(msg){var targetMid=msg.mid;this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.WELCOME,targetMid),this._trigger("peerJoined",targetMid),this._peerConnections[targetMid]||this._openPeer(targetMid,!0)},Skyway.prototype._offerHandler=function(msg){var targetMid=msg.mid;this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.OFFER,targetMid);var offer=new window.RTCSessionDescription(msg),pc=this._peerConnections[targetMid];pc||(this._openPeer(targetMid,!1),pc=this._peerConnections[targetMid]),pc.setRemoteDescription(offer),this._doAnswer(targetMid)},Skyway.prototype._doAnswer=function(targetMid){var pc=this._peerConnections[targetMid],self=this;pc&&pc.createAnswer(function(answer){self._setLocalAndSendMessage(targetMid,answer)},function(error){self._onOfferOrAnswerError(targetMid,error,"answer")},self._room.pcHelper.sdpConstraints)},Skyway.prototype._onOfferOrAnswerError=function(targetMid,error,type){},Skyway.prototype._openPeer=function(targetMid,toOffer){if(this._peerConnections[targetMid]=this._createPeerConnection(targetMid),this._user.streams.length>0)for(var i in this._user.streams)this._user.streams.hasOwnProperty(i)&&this._peerConnections[targetMid].addStream(this._user.streams[i]);toOffer&&(this._createDataChannel(this._user.sid,targetMid),this._doCall(targetMid))},Skyway.prototype._onRemoteStreamAdded=function(targetMid,event){this._trigger("addPeerStream",targetMid,event.stream)},Skyway.prototype._doCall=function(targetMid){var pc=this._peerConnections[targetMid],oc=this._room.pcHelper.offerConstraints;if(window.webrtcDetectedBrowser.webkitWebRTC)for(var prop in oc.mandatory)oc.mandatory.hasOwnProperty(prop)&&-1!==prop.indexOf("Moz")&&delete oc.mandatory[prop];var constraints=oc,sc=this._room.pcHelper.sdpConstraints;for(var name in sc.mandatory)sc.mandatory.hasOwnProperty(name)&&(constraints.mandatory[name]=sc.mandatory[name]);constraints.optional.concat(sc.optional);var self=this;pc.createOffer(function(offer){self._setLocalAndSendMessage(targetMid,offer)},function(error){self._onOfferOrAnswerError(targetMid,error,"offer")},constraints)},Skyway.prototype._setLocalAndSendMessage=function(targetMid,sessionDescription){var pc=this._peerConnections[targetMid],self=this;pc.setLocalDescription(sessionDescription,function(){self._trigger("handshakeProgress",sessionDescription.type,targetMid),self._sendMessage({type:sessionDescription.type,sdp:sessionDescription.sdp,mid:self._user.sid,target:targetMid,rid:self._room.id})},function(){})},Skyway.prototype._createPeerConnection=function(targetMid){var pc;try{pc=new window.RTCPeerConnection(this._room.pcHelper.pcConfig,this._room.pcHelper.pcConstraints)}catch(e){return null}var self=this;return pc.ondatachannel=function(event){var dc=event.channel||event;self._createDataChannel(self._user.sid,targetMid,null,dc)},pc.onaddstream=function(event){self._onRemoteStreamAdded(targetMid,event)},pc.onicecandidate=function(event){self._onIceCandidate(targetMid,event)},pc.oniceconnectionstatechange=function(){self._trigger("iceConnectionState",pc.iceConnectionState,targetMid)},pc.onsignalingstatechange=function(){var signalingState=pc.signalingState;pc.signalingState!==self.PEER_CONNECTION_STATE.STABLE&&pc.signalingState!==self.PEER_CONNECTION_STATE.CLOSED?pc.hasSetOffer=!0:pc.signalingState===self.PEER_CONNECTION_STATE.STABLE&&pc.hasSetOffer&&(signalingState=self.PEER_CONNECTION_STATE.ESTABLISHED),self._trigger("peerConnectionState",signalingState,targetMid)},pc.onicegatheringstatechange=function(){self._trigger("candidateGenerationState",pc.iceGatheringState,targetMid)},pc},Skyway.prototype._onIceCandidate=function(targetMid,event){if(event.candidate){{var msgCan=event.candidate.candidate.split(" ");msgCan[7]}this._sendMessage({type:"candidate",label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate,mid:this._user.sid,target:targetMid,rid:this._room.id})}else this._trigger("candidateGenerationState",this.CANDIDATE_GENERATION_STATE.DONE,targetMid)},Skyway.prototype._candidateHandler=function(msg){var targetMid=msg.mid,pc=this._peerConnections[targetMid];if(pc){if(pc.iceConnectionState===this.ICE_CONNECTION_STATE.CONNECTED)return;var msgCan=msg.candidate.split(" "),index=(msgCan[7],msg.label),candidate=new window.RTCIceCandidate({sdpMLineIndex:index,candidate:msg.candidate});pc.addIceCandidate(candidate)}},Skyway.prototype._answerHandler=function(msg){var targetMid=msg.mid;this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.ANSWER,targetMid);var answer=new window.RTCSessionDescription(msg),pc=this._peerConnections[targetMid];pc.setRemoteDescription(answer),pc.remotePeerReady=!0},Skyway.prototype._sendMessage=function(message){if(this._channel_open){var msgString=JSON.stringify(message);if("chat"==message.type)if(this._chatDC){var msgDc=this._user.displayName+"|"+message.data;if("target"in message){var targetId=message.target;msgDc="CHAT|PRIVATE|"+msgDc,this._sendDcChat(targetId,msgDc)}else{msgDc="CHAT|GROUP|"+msgDc;for(var targetId in this._peerConnections)this._sendDcChat(targetId,msgDc)}this._chatSig&&this._socket.send(msgString)}else this._chatSig&&this._socket.send(msgString);else this._socket.send(msgString)}},Skyway.prototype._sendDcChat=function(targetId,msgDc){var dc,channelInit=this._user.sid+"_"+targetId,channelRspd=targetId+"_"+this._user.sid;if(RTCDataChannels[channelInit]?dc=RTCDataChannels[channelInit]:RTCDataChannels[channelRspd]?dc=RTCDataChannels[channelRspd]:_createDataChannel(this._user.sid,targetId,null,null),null==dc&&(dc=RTCDataChannels[channelInit]),null!=dc){dc.send(msgDc);{var charCodes=this._toCharCode(msgDc,4);this._codeToChar(charCodes,4)}}},Skyway.prototype._processDcChat=function(dc,dataStr){var data=dataStr.split("|"),msgType=data[0];if("CHAT"!=msgType)return!1;for(var msgChatType=data[1],msgNick=data[2],start=3+data.slice(0,3).join("").length,msgChat="",i=start;i<dataStr.length;i++)msgChat+=dataStr[i];var msgMid="";msgMid=dc.createId==this._user.sid?dc.receiveId:dc.createId;var chatDisplay="[DC]: "+msgChat,msg={type:"chat",mid:msgMid,nick:msgNick,data:chatDisplay};return"PRIVATE"==msgChatType&&(msg.target=this._user.sid),this._processSingleMsg(msg),!0},Skyway.prototype._toCharCode=function(strIn,width){for(var strOut="",i=0;i<strIn.length;i++)strOut+=this._padLeft(strIn.charCodeAt(i)," ",width);return strOut},Skyway.prototype._codeToChar=function(strIn,width){for(var strOut="",i=0;i<strIn.length;i+=width)strOut+=String.fromCharCode(strIn.substring(i,i+width));return strOut},Skyway.prototype._padLeft=function(strIn,padder,width){for(var strOut=strIn;strOut.toString().length<width;)strOut=padder+strOut;return strOut},Skyway.prototype._stripNonAlphanumeric=function(str){for(var strOut="",i=0;i<str.length;i++){var curChar=str[i];this._alphanumeric(curChar)&&(strOut+=curChar)}return strOut},Skyway.prototype._alphanumeric=function(str){var letterNumber=/^[0-9a-zA-Z]+$/;return str.match(letterNumber)?!0:!1},Skyway.prototype._openChannel=function(){var self=this,_openChannelImpl=function(readyState){if(2===readyState){self.off("readyStateChange",_openChannelImpl);var ip_signaling="ws://"+self._room.signalingServer.ip+":"+self._room.signalingServer.port;self._socket=self._socketVersion>=1?io.connect(ip_signaling,{forceNew:!0}):window.io.connect(ip_signaling,{"force new connection":!0}),self._socket=window.io.connect(ip_signaling,{"force new connection":!0}),self._socket.on("connect",function(){self._channel_open=!0,self._trigger("channelOpen")}),self._socket.on("error",function(err){self._channel_open=!1,self._trigger("channelError",err)}),self._socket.on("disconnect",function(){self._trigger("channelClose")}),self._socket.on("message",function(msg){self._processSigMsg(msg)})}};this._channel_open||(0===this._readyState?(this.on("readyStateChange",_openChannelImpl),this._init(this)):_openChannelImpl(2))},Skyway.prototype._closeChannel=function(){this._channel_open&&(this._socket.disconnect(),this._socket=null,this._channel_open=!1,this._readyState=0)},Skyway.prototype._createDataChannel=function(createId,receiveId,channel_name,dc){var self=this,pc=self._peerConnections[receiveId],channel_log="API - DataChannel [-]["+createId+"]: ",peer=self._user.sid===receiveId?createId:receiveId,initialDC=!0;try{if(dc)channel_name=dc.label,onDC=!0,channel_log="API - DC [{on}"+channel_name+"]["+createId+"]: ";else{channel_name?initialDC=!1:channel_name=createId+"_"+receiveId,channel_log="API - DataChannel ["+channel_name+"]["+createId+"]: ";var options={};webrtcDetectedBrowser.isSCTPDCSupported||(options.reliable=!1),dc=pc.createDataChannel(channel_name,options)}self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.NEW,peer,initialDC),webrtcDetectedBrowser.mozWebRTC,dc.createId=createId,dc.receiveId=receiveId,dc.onerror=function(err){self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.ERROR,peer,initialDC)},dc.onclose=function(){self._closeDataChannel(channel_name),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.CLOSED,peer,initialDC)},dc.onopen=function(){dc.push=dc.send,dc.send=function(data){dc.push(data)}},dc.onmessage=function(event){self._processDcChat(dc,event.data)||self._dataChannelHandler(event.data,channel_name,self)},window.RTCDataChannels[channel_name]=dc,self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.LOADED,peer,initialDC),setTimeout(function(){self._trigger("dataChannelState",dc.readyState,peer,initialDC),dc.readyState===self.DATA_CHANNEL_STATE.OPEN&&self._sendDataChannel(channel_name,"CONN|"+channel_name+"|"+self._user.sid+"|"+initialDC)},500)}catch(err){return}},Skyway.prototype._sendDataChannel=function(channel,data){if(!channel)return!1;var dataChannel=window.RTCDataChannels[channel];if(dataChannel)try{dataChannel.send(data)}catch(err){}},Skyway.prototype._closeDataChannel=function(channel){if(channel)try{if(!window.RTCDataChannels[channel])return;window.RTCDataChannels[channel].close()}catch(err){}finally{setTimeout(function(){delete window.RTCDataChannels[channel]},500)}},Skyway.prototype._dataChannelPeer=function(channel,self){return window.RTCDataChannels[channel].createId===self._user.sid?window.RTCDataChannels[channel].receiveId:window.RTCDataChannels[channel].createId},Skyway.prototype._dataChannelHandler=function(dataString,channel,self){if("string"==typeof dataString)if(dataString.indexOf("|")>-1&&dataString.indexOf("|")<6){isProtocolEst=!0;var data=dataString.split("|");switch(data[0]){case"CONN":self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.OPEN,data[2],Boolean(data[3]));break;case"WRQ":self._dataChannelWRQHandler(data,channel,self);break;case"ACK":self._dataChannelACKHandler(data,channel,self);break;case"ERROR":self._dataChannelERRORHandler(data,channel,self)}}else self._dataChannelDATAHandler(dataString,channel,self.DATA_TRANSFER_DATA_TYPE.BINARYSTRING,self);else dataString instanceof ArrayBuffer?self._dataChannelDATAHandler(dataString,channel,self.DATA_TRANSFER_DATA_TYPE.ARRAYBUFFER,self):dataString instanceof Blob&&self._dataChannelDATAHandler(dataString,channel,self.DATA_TRANSFER_DATA_TYPE.BLOB,self)},Skyway.prototype._dataChannelWRQHandler=function(data,channel,self){var acceptFile=confirm("Do you want to receive File "+data[2]+"?"),itemId=this._user.sid+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".","");acceptFile?(self._downloadDataTransfers[channel]={itemId:itemId,filename:data[2],filesize:parseInt(data[3],10),data:[],ackN:0,totalReceivedSize:0,chunkSize:parseInt(data[4],10),timeout:parseInt(data[5],10),ready:!1},self._sendDataChannel(channel,"ACK|0|"+window.webrtcDetectedBrowser.browser),this._trigger("startDataTransfer",itemId,this._dataChannelPeer(channel,this),data[2],data[3],self.DATA_TRANSFER_TYPE.DOWNLOAD)):self._sendDataChannel(channel,"ACK|-1")},Skyway.prototype._dataChannelACKHandler=function(data,channel,self){self._clearDataChannelTimeout(channel,!0,self);var ackN=parseInt(data[1],10),chunksLength=self._uploadDataTransfers[channel].chunks.length,timeout=self._uploadDataTransfers[channel].info.timeout;if(ackN>-1){if(chunksLength>ackN){var fileReader=new FileReader;fileReader.onload=function(){var base64BinaryString=fileReader.result.split(",")[1];self._sendDataChannel(channel,base64BinaryString),self._setDataChannelTimeout(channel,timeout,!0,self),self._trigger("dataTransfer",self._uploadDataTransfers[channel].info.itemId,self.DATA_TRANSFER_TYPE.UPLOAD,(ackN+1)/chunksLength,self._dataChannelPeer(channel,self))},fileReader.readAsDataURL(self._uploadDataTransfers[channel].chunks[ackN])}else if(ackN===chunksLength){var itemId=self._uploadDataTransfers[channel].info.itemId;self._trigger("dataTransferCompleted",itemId,userID),setTimeout(function(){delete self._uploadDataTransfers[channel]},1200)}}else alert("User rejected your file"),delete self._uploadDataTransfers[channel]},Skyway.prototype._dataChannelERRORHandler=function(data,channel,self){var isSender;try{isSender=data[2]}catch(err){}self._clearDataChannelTimeout(channel,isSender,self),alert("File failed to send! Reason was:\n"+data[1]+"\nChannel: "+channel+"\nUploader: "+isSender)},Skyway.prototype._dataChannelDATAHandler=function(dataString,channel,dataType,self){self._clearDataChannelTimeout(channel,!1,self);var chunk;if(dataType===self.DATA_TRANSFER_DATA_TYPE.BINARYSTRING)chunk=self._base64ToBlob(dataString);else if(dataType===self.DATA_TRANSFER_DATA_TYPE.ARRAYBUFFER)chunk=new Blob(dataString);else{if(dataType!==self.DATA_TRANSFER_DATA_TYPE.BLOB)return;chunk=dataString}var completedDetails=self._downloadDataTransfers[channel],receivedSize=chunk.size*(4/3);if(completedDetails.chunkSize>=receivedSize){self._downloadDataTransfers[channel].data.push(chunk),self._downloadDataTransfers[channel].ackN+=1,self._downloadDataTransfers[channel].totalReceivedSize+=receivedSize;var totalReceivedSize=self._downloadDataTransfers[channel].totalReceivedSize,percentage=totalReceivedSize/completedDetails.filesize;if(self._sendDataChannel(channel,"ACK|"+self._downloadDataTransfers[channel].ackN+"|"+self._user.sid),completedDetails.chunkSize===receivedSize)self._trigger("dataTransfer",completedDetails.itemId,self.DATA_TRANSFER_TYPE.DOWNLOAD,percentage),self._setDataChannelTimeout(channel,self._downloadDataTransfers[channel].timeout,!1,self);else{var blob=new Blob(self._downloadDataTransfers[channel].data);self._trigger("dataTransfer",completedDetails.itemId,self.DATA_TRANSFER_TYPE.DOWNLOAD,percentage,null,URL.createObjectURL(blob)),setTimeout(function(){delete self._downloadDataTransfers[channel]},1200)}}},Skyway.prototype._setDataChannelTimeout=function(channel,timeout,isSender,self){var key="_"+(isSender?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD);self._dataTransfersTimeout[channel+key]=setTimeout(function(){isSender?self._uploadDataTransfers[channel]={}:self._downloadDataTransfers[channel]={},self._sendDataChannel(channel,"ERROR|Connection Timeout. Longer than "+timeout+" seconds. Connection is abolished.|"+isSender)},1e3*timeout)},Skyway.prototype._clearDataChannelTimeout=function(channel,isSender,self){var key="_"+(isSender?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD);clearTimeout(self._dataTransfersTimeout[channel+key]),delete self._dataTransfersTimeout[channel+key]},Skyway.prototype._base64ToBlob=function(dataURL){for(var byteString=atob(dataURL.replace(/\s\r\n/g,"")),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),j=0;j<byteString.length;j++)ia[j]=byteString.charCodeAt(j);return new Blob([ab])},Skyway.prototype._chunkFile=function(blob,blobByteSize){var chunksArray=[],startCount=0,endCount=0;if(blobByteSize>this._chunkFileSize){for(;blobByteSize-1>endCount;)endCount=startCount+this._chunkFileSize,chunksArray.push(blob.slice(startCount,endCount)),startCount+=this._chunkFileSize;blobByteSize-(startCount+1)>0&&chunksArray.push(blob.slice(startCount,blobByteSize-1))}else chunksArray.push(blob);return chunksArray},Skyway.prototype.sendFile=function(file){var noOfPeersSent=0,itemId=this._user.sid+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),timeout=60;for(var channel in window.RTCDataChannels)if(window.RTCDataChannels.hasOwnProperty(channel)&&window.RTCDataChannels[channel]&&"open"===window.RTCDataChannels[channel].readyState){var fileSize=(file.size*(4/3)).toFixed(),chunkSize=(this._chunkFileSize*(4/3)).toFixed();this._uploadDataTransfers[channel]={info:{name:file.name,size:fileSize,itemId:itemId,timeout:timeout},chunks:this._chunkFile(file,file.size)},this._sendDataChannel(channel,"WRQ|"+window.webrtcDetectedBrowser.browser+"|"+file.name+"|"+fileSize+"|"+chunkSize+"|"+timeout),noOfPeersSent++,this._setDataChannelTimeout(channel,timeout,!0,this)}noOfPeersSent>0?this._trigger("startDataTransfer",itemId,this._user.sid,file.name,file.size,this.DATA_TRANSFER_TYPE.UPLOAD,URL.createObjectURL(file)):this._uploadDataTransfers={}},Skyway.prototype.toggleLock=function(){},Skyway.prototype.toggleAudio=function(){},Skyway.prototype.toggleVideo=function(){},Skyway.prototype.joinRoom=function(){if(!this._in_room){var self=this,_sendJoinRoomMsg=function(){self.off("channelOpen",_sendJoinRoomMsg),self._sendMessage({type:"joinRoom",uid:self._user.id,cid:self._key,rid:self._room.id,userCred:self._user.token,timeStamp:self._user.timeStamp,apiOwner:self._user.apiOwner,roomCred:self._room.token,start:self._room.start,len:self._room.len}),this._user.peer=this._createPeerConnection(this._user.id)};this._channel_open?_sendJoinRoomMsg():(this.on("channelOpen",_sendJoinRoomMsg),this._openChannel())}},Skyway.prototype.leaveRoom=function(){if(this._in_room){for(var pc_index in this._peerConnections)this._peerConnections.hasOwnProperty(pc_index)&&this._removePeer(pc_index);this._in_room=!1,this._closeChannel()}}}).call(this);